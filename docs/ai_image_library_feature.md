# Feature Guide: AI Image Library & Step Background Generator\n\n## 1. Introduction & Goal\n\nThis document outlines the implementation plan for an enhanced feature allowing administrators to manage and generate background images for wizard steps. This replaces a simple generation button with a modal-based **Image Library** offering browsing of personal/public images and a structured AI generation tool.\n\n**Goals:**\n\n1.  **Centralized Image Management:** Provide a library for admins to view images they\'ve generated and public images from their community.\n2.  **Structured Generation:** Offer a user-friendly interface with defined fields (Style, Subject, etc.) to guide AI image generation (DALL·E 3).\n3.  **Easy Selection & Reuse:** Allow admins to easily select any image from the library to apply as a background to the current step.\n4.  **Sharing Control:** Enable admins to mark their generated images as \"public\" for others in their community to potentially use.\n5.  **Quota Integration:** Ensure all AI image generations are tracked against community quotas.\n6.  **Persistence:** Store image metadata (URL, prompt details, creator, public status) in the database and image files in object storage.\n7.  **Seamless Workflow:** Integrate this library modal smoothly into the `StepEditor` admin UI.\n\n## 2. High-Level Workflow\n\n**A) Image Generation & Saving:**\n\n```mermaid\nsequenceDiagram\n    participant AdminUI as Admin (ImageLibraryModal - Generate Tab)\n    participant BackendAPI as Backend API <br>(/api/admin/steps/generate-background)\n    participant QuotaLib as Quota Check\n    participant OpenAI\n    participant Storage as Object Storage\n    participant ImageDB as generated_images Table\n    participant UsageDB as usage_events Table\n\n    AdminUI->>+BackendAPI: POST Request (wizardId, stepId, structuredPrompt)\n    BackendAPI->>+QuotaLib: Check Quota ('image_generation', communityId)\n    alt Quota Exceeded\n        QuotaLib-->>-BackendAPI: Error (402)\n        BackendAPI-->>-AdminUI: Error Response (402)\n    else Quota OK\n        QuotaLib-->>-BackendAPI: OK\n        BackendAPI->>BackendAPI: Augment/Format Prompt from structuredPrompt\n        BackendAPI->>+OpenAI: Generate Image (formattedPrompt)\n        OpenAI-->>-BackendAPI: Temporary Image URL\n        BackendAPI->>BackendAPI: Download Image Data\n        BackendAPI->>+Storage: Upload Image Data (unique key)\n        Storage-->>-BackendAPI: Persistent Image URL\n        BackendAPI->>+ImageDB: INSERT Image Metadata (URL, prompt, userId, communityId, is_public=false)\n        ImageDB-->>-BackendAPI: Image Record Created\n        BackendAPI->>+UsageDB: Log Usage Event ('image_generation')\n        UsageDB-->>-BackendAPI: Logged\n        BackendAPI-->>-AdminUI: Success Response { imageUrl: persistentUrl }\n        AdminUI->>AdminUI: Display generated image, refresh \"My Images\" list\n    end\n```\n\n**B) Selecting an Image:**\n\n```mermaid\nsequenceDiagram\n    participant AdminUIModal as Admin (ImageLibraryModal - Browse Tab)\n    participant AdminUIStep as Admin (StepEditor)\n    participant StepDB as onboarding_steps Table\n\n    AdminUIModal->>AdminUIModal: User selects an image (URL known)\n    AdminUIModal->>AdminUIStep: onSelect(selectedImageUrl)\n    AdminUIStep->>+StepDB: Update Step Config (PATCH /api/wizards/.../steps/[stepId] with new backgroundImageUrl)\n    StepDB-->>-AdminUIStep: Step Updated\n    AdminUIStep->>AdminUIStep: Close Modal, Update Preview\n```\n\n## 3. Database Modifications ✅ [DONE]\n\n### 3.1. `feature_enum` Type ✅ [DONE]\n(Requires previous migration or inclusion here)\n*   **Action:** Ensure `'image_generation'` value exists in `feature_enum`.\n*   **SQL:** `ALTER TYPE feature_enum ADD VALUE IF NOT EXISTS 'image_generation';`\n*   **Associated Limits:** Ensure limits are defined in `plan_limits` for this feature.\n
### 3.2. New Table: `generated_images` ✅ [DONE]\n*   **Purpose:** Store metadata for every successfully generated and stored image.\n*   **Migration File:** `migrations/<timestamp>_create_generated_images_table.js`\n*   **Schema:**\n    ```sql\n    CREATE TABLE generated_images (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id TEXT NOT NULL, -- Could reference a users table if one exists formally\n        community_id TEXT NOT NULL REFERENCES communities(id) ON DELETE CASCADE,\n        storage_url TEXT NOT NULL UNIQUE, -- URL from object storage\n        prompt_structured JSONB NOT NULL, -- Store structured prompt { style, subject, etc. }\n        is_public BOOLEAN NOT NULL DEFAULT false,\n        created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n    );\n\n    -- Index for fetching user's images\n    CREATE INDEX idx_generated_images_user_created ON generated_images (user_id, created_at DESC);\n\n    -- Index for fetching public images within a community\n    CREATE INDEX idx_generated_images_community_public ON generated_images (community_id, is_public, created_at DESC) WHERE is_public = true;\n    ```\n
### 3.3. `onboarding_steps` Table ✅ [DONE]\n*   **No Schema Change.** The selected image's `storage_url` is stored in `config.presentation.backgroundImageUrl`.

## 4. Environment Variables ✅ [DONE]\n(Same as previous plan)\n*   `OPENAI_API_KEY`\n*   `STORAGE_ACCESS_KEY_ID`\n*   `STORAGE_SECRET_ACCESS_KEY`\n*   `STORAGE_BUCKET_NAME`\n*   `STORAGE_REGION`\n*   `STORAGE_ENDPOINT_URL`\n*   `STORAGE_PUBLIC_URL_PREFIX` (Recommended)

## 5. Storage Utility (`src/lib/storage.ts`) ✅ [DONE]\n*   **Update `uploadImageFromUrl` Key Generation:** Use a more generic, globally unique key, not tied to step ID. Example: `communityId/images/<uuid>.png`. The step association is via the step's config.\n    *   Modify function signature if needed (e.g., pass `communityId` instead of `pathPrefix`).

## 6. Backend API Endpoints ✅ [DONE]\n
### 6.1. Image Generation (`POST /api/admin/steps/generate-background` - Modified) ✅ [DONE]\n*   Accept `wizardId`, `stepId`, `structuredPrompt: object`.\n*   Perform Auth, Quota Check (`image_generation`).\n*   Format `structuredPrompt` into a string for OpenAI (e.g., `"${style}, ${subject}, ${mood}"` plus style prefix).\n*   Call OpenAI `images.generate`.\n*   Fetch image data, call `uploadImageFromUrl` (passing `communityId` for key generation).\n*   **INSERT** record into `generated_images` table (userId, communityId, persistentUrl, structuredPrompt, is_public=false).\n*   Log usage event (`image_generation`).\n*   Return `{ imageUrl: persistentUrl }`.\n
### 6.2. List Images (`GET /api/admin/images` - New) ✅ [DONE]\n*   Admin-only (`withAuth(..., true)`).\n*   Accept `scope=mine|public` query parameter.\n*   Implement database queries based on `scope`:\n    *   `mine`: `SELECT * FROM generated_images WHERE user_id = $1 ORDER BY created_at DESC` (using `req.user.sub`).\n    *   `public`: `SELECT * FROM generated_images WHERE community_id = $1 AND is_public = true ORDER BY created_at DESC` (using `req.user.cid`).\n*   Return `{ images: [...] }`.

### 6.3. Toggle Public Status (`PATCH /api/admin/images/[imageId]/toggle-public` - New) ✅ [DONE]\n*   Admin-only (`withAuth(..., true)`).\n*   Accept `imageId` from path.\n*   Verify image exists and belongs to the requesting admin (`user_id = req.user.sub`). Return 404/403 if not.\n*   `UPDATE generated_images SET is_public = NOT is_public WHERE id = $1 AND user_id = $2`.\n*   Return `{ success: true }` or the updated image record.\n
## 7. Frontend Hooks [NEXT STEPS]
*   **Implementation Note:** These hooks will utilize the `useAuthFetch` hook (`src/lib/authFetch.ts`) directly within their `queryFn` or `mutationFn` to make authenticated API calls, following the established pattern in the codebase (no separate API client layer needed).
*   **Required Type:** Define `GeneratedImage` type in `src/types/images.ts` based on the DB table.
*   **`useAdminImagesQuery` (`src/hooks/useAdminImagesQuery.ts` - New):**
    *   Variables: `{ scope: 'mine' | 'public' }`.
    *   Calls `GET /api/admin/images?scope={scope}` using `useAuthFetch`.
    *   Returns `{ images: GeneratedImage[] }`.
*   **`useToggleImagePublicMutation` (`src/hooks/useToggleImagePublicMutation.ts` - New):**
    *   Variables: `{ imageId: string }`.
    *   Calls `PATCH /api/admin/images/[imageId]/toggle-public` using `useAuthFetch`.
    *   On success, invalidates `useAdminImagesQuery` cache.
*   **`useGenerateAndSaveImageMutation` (`src/hooks/useGenerateAndSaveImageMutation.ts` - New):**\n    *   Variables: `{ wizardId: string, stepId: string, structuredPrompt: object }`.\n    *   Calls `POST /api/admin/steps/generate-background` using `useAuthFetch`.
    *   On success, invalidates `useAdminImagesQuery({ scope: 'mine' })`.
    *   Returns `{ imageUrl: string }`.
*   **`useUpdateStep` (Existing):** No changes needed, still used by `StepEditor` to save the final selected URL to the step config.\n
## 8. Frontend Admin UI [TODO]
### 8.1. Image Library Modal (`src/components/onboarding/ImageLibraryModal.tsx` - New)\n*   **Props:** `isOpen`, `onClose`, `onSelect: (imageUrl: string) => void`.
*   **Internal State:** Current tab (`generate`, `mine`, `public`), structured prompt fields, loading/error states for generation/listing, potentially selected image URL.\n*   **Tabs:**
    *   **Generate:** Structured prompt inputs (Style, Subject, Mood - using `Input`, `Textarea`, `Select`). \"Generate\" button triggers `useGenerateAndSaveImageMutation`. Displays preview of last generated image. Error display area.\n    *   **My Images:** Fetches using `useAdminImagesQuery({ scope: 'mine' })`. Displays images in a grid. Each image is selectable (calls `props.onSelect`). Each image has a toggle button (using `Switch`?) calling `useToggleImagePublicMutation`. Loading/error states.\n    *   **Public Images:** Fetches using `useAdminImagesQuery({ scope: 'public' })`. Displays images in a grid. Each image is selectable (calls `props.onSelect`). Loading/error states.\n*   **UI:** Use `Dialog` for modal, `Tabs` for sections, `Card` or similar for image grid items.

### 8.2. Step Editor (`src/components/onboarding/steps/StepEditor.tsx`)\n*   Remove any previous direct image generation UI.\n*   **State:** Add `isImageLibraryOpen: boolean`.\n*   **UI Elements:**
    *   Image Preview: Display current `step.config.presentation.backgroundImageUrl`.
    *   Button: \"Choose Background\" or \"Change Background\". Sets `isImageLibraryOpen` to true.\n*   **Logic:**
    *   Render `<ImageLibraryModal isOpen={isImageLibraryOpen} onClose={() => setIsImageLibraryOpen(false)} onSelect={handleImageSelected} />`.
    *   Implement `handleImageSelected(imageUrl: string)` function:
        *   Calls `updateStep.mutate({ config: { ...step.config, presentation: { ...(step.config.presentation || {}), backgroundImageUrl: imageUrl } } })`.
        *   Closes the modal: `setIsImageLibraryOpen(false)`.\n
## 9. Frontend User UI\n
*   **No Change:** The logic in `StepDisplay.tsx` (or relevant step components) to read `step.config.presentation.backgroundImageUrl` and apply it as a background style remains the same as planned initially.

## 10. Open Questions / Decisions

*   **Structured Prompt Fields:** Finalize the specific fields (Style, Subject, Mood, Color, etc.) and their UI representation (text, select, tags).
*   **Public Sharing Scope:** Confirm if "Public" means public within the *community* or platform-wide (Recommend starting with community-only). How is this displayed/explained?
*   **Storage Key Structure:** Confirm final S3 key structure (e.g., `communityId/images/<uuid>.png`).
*   **Error Handling/UX:** Refine how different errors (Quota, OpenAI Policy, Storage, Network) are presented in the modal.
*   **UI Polish:** Design specifics of the image grid, selection indication, loading states.

This revised plan provides a more robust and feature-rich implementation for AI background images. 